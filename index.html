<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, minimal-ui">
<meta name="mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<!-- Open Graph: WhatsApp / Telegram / social preview -->
<meta property="og:title" content="8√ó8 Dilated Bene≈° Photonic Switch">
<meta property="og:description" content="48 MZI Switches ¬∑ 6 Stages ¬∑ Interactive Dashboard ‚Äî tap to explore routing paths">
<meta property="og:image" content="https://ronen4a.github.io/8x8-Dilated-Benes-Switch/og-preview.png">
<meta property="og:url" content="https://ronen4a.github.io/8x8-Dilated-Benes-Switch/">
<meta property="og:type" content="website">
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:title" content="8√ó8 Dilated Bene≈° Photonic Switch">
<meta name="twitter:description" content="48 MZI Switches ¬∑ 6 Stages ¬∑ Interactive Dashboard">
<meta name="twitter:image" content="https://ronen4a.github.io/8x8-Dilated-Benes-Switch/og-preview.png">
<title>8√ó8 Dilated Bene≈° ‚Äî Photonic Switch Dashboard</title>
<link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Mono:wght@400;500;600;700&family=Outfit:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
<style>
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
:root{
  --bg:#06080f;--surface:#0c1120;--card:#111828;--border:#1a2340;
  --text:#e2e8f0;--muted:#64748b;--dim:#334155;
  --red:#f87171;--orange:#fb923c;--yellow:#facc15;--green:#4ade80;
  --blue:#38bdf8;--indigo:#818cf8;--purple:#c084fc;--pink:#f472b6;
  --glass:rgba(12,17,32,.72);--glass-border:rgba(255,255,255,.06);
  --radius:16px;--radius-sm:10px;--radius-xs:8px;
}

html{-webkit-text-size-adjust:100%;-webkit-tap-highlight-color:transparent}
body{background:var(--bg);color:var(--text);font-family:'IBM Plex Mono','Fira Code',monospace;min-height:100vh;min-height:100dvh;overflow-x:hidden;-webkit-font-smoothing:antialiased}

/* Animated background */
body::before{content:'';position:fixed;inset:0;z-index:0;pointer-events:none;
  background:
    radial-gradient(ellipse 600px 400px at 20% 20%, rgba(129,140,248,.06) 0%, transparent 70%),
    radial-gradient(ellipse 500px 350px at 80% 80%, rgba(192,132,252,.05) 0%, transparent 70%),
    radial-gradient(ellipse 400px 300px at 50% 50%, rgba(56,189,248,.03) 0%, transparent 70%);
  animation:bgShift 20s ease-in-out infinite alternate}
@keyframes bgShift{0%{opacity:.6}50%{opacity:1}100%{opacity:.7}}

/* Subtle grid overlay */
body::after{content:'';position:fixed;inset:0;z-index:0;pointer-events:none;
  background-image:linear-gradient(rgba(255,255,255,.015) 1px,transparent 1px),linear-gradient(90deg,rgba(255,255,255,.015) 1px,transparent 1px);
  background-size:40px 40px}

.dash{position:relative;z-index:1;max-width:1400px;margin:0 auto;padding:16px 12px 32px}

/* ‚îÄ‚îÄ HEADER ‚îÄ‚îÄ */
.header{text-align:center;margin-bottom:16px;position:relative;padding:8px 0 20px}
.header::after{content:'';position:absolute;bottom:0;left:50%;transform:translateX(-50%);width:180px;height:2px;
  background:linear-gradient(90deg,transparent,var(--orange),var(--red),var(--purple),transparent);border-radius:2px}
.header h1{font-family:'Outfit',sans-serif;font-size:clamp(18px,5vw,26px);font-weight:800;letter-spacing:.04em;
  background:linear-gradient(135deg,var(--orange) 0%,var(--red) 40%,var(--purple) 100%);
  -webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text;text-transform:uppercase;line-height:1.2}
.header .sub{font-size:clamp(9px,2.5vw,11px);color:var(--muted);margin-top:6px;letter-spacing:.04em;line-height:1.5;padding:0 8px}

/* ‚îÄ‚îÄ STATUS BAR ‚îÄ‚îÄ */
.sbar{display:flex;justify-content:center;gap:8px;margin-bottom:12px;flex-wrap:wrap;padding:0 4px}
.pill{padding:6px 14px;border-radius:20px;font-size:11px;font-weight:600;border:1px solid;letter-spacing:.03em;
  display:flex;align-items:center;gap:6px;backdrop-filter:blur(12px);background:var(--glass);white-space:nowrap}
.dot{width:7px;height:7px;border-radius:50%;animation:pulse 2s infinite}
@keyframes pulse{0%,100%{opacity:1}50%{opacity:.3}}

/* ‚îÄ‚îÄ CONTROL BAR ‚îÄ‚îÄ */
.cbar{display:flex;align-items:center;gap:8px;margin-bottom:12px;flex-wrap:wrap;justify-content:center;padding:0 4px}
.cbar-section{display:flex;align-items:center;gap:6px;background:var(--glass);border:1px solid var(--glass-border);
  border-radius:var(--radius-sm);padding:7px 12px;backdrop-filter:blur(16px);flex-shrink:0}
#presetsBar{flex-wrap:wrap;justify-content:center;flex-shrink:1;min-width:0}
.cbar-lbl{font-size:9px;color:var(--dim);font-weight:700;letter-spacing:.08em;margin-right:4px}

/* ‚îÄ‚îÄ BUTTONS ‚îÄ‚îÄ */
.pbtn{background:var(--surface);color:var(--muted);border:1px solid var(--border);border-radius:var(--radius-xs);
  padding:6px 12px;font-size:11px;font-family:inherit;cursor:pointer;transition:all .2s;white-space:nowrap;
  -webkit-tap-highlight-color:transparent;touch-action:manipulation}
.pbtn:hover,.pbtn:active{background:var(--card);color:var(--text);border-color:var(--dim);transform:translateY(-1px)}
.pbtn:active{transform:translateY(0)}

.rbtn{padding:8px 20px;border-radius:var(--radius-xs);font-size:11px;font-weight:700;font-family:inherit;
  cursor:pointer;border:none;letter-spacing:.04em;transition:all .25s;touch-action:manipulation;white-space:nowrap}
.rbtn.on{background:linear-gradient(135deg,var(--orange),var(--red));color:var(--bg);
  box-shadow:0 4px 24px rgba(248,113,113,.3),0 0 0 1px rgba(248,113,113,.15)}
.rbtn.off{background:var(--surface);color:var(--dim);cursor:default;border:1px solid var(--border)}

.rmsg{font-size:10px;padding:6px 12px;border-radius:var(--radius-xs);border:1px solid;line-height:1.4;display:inline-block}

.helpbtn{background:none;border:1px solid var(--dim);color:var(--muted);font-size:10px;font-family:inherit;
  font-weight:600;padding:5px 12px;border-radius:var(--radius-xs);cursor:pointer;transition:all .2s;touch-action:manipulation}
.helpbtn:hover,.helpbtn:active{border-color:var(--orange);color:var(--orange)}

.helpbox{display:none;background:rgba(251,146,60,.04);border:1px solid rgba(251,146,60,.12);border-radius:var(--radius-sm);
  padding:10px 14px;font-size:11px;color:var(--orange);line-height:1.6;margin-bottom:12px;text-align:center}
.helpbox.show{display:block}

/* ‚îÄ‚îÄ FEATURE TOGGLES ‚îÄ‚îÄ */
.ftbar{display:flex;justify-content:center;gap:6px;margin-bottom:12px;flex-wrap:nowrap;padding:0 4px;overflow-x:auto;-webkit-overflow-scrolling:touch}
.ftbar::-webkit-scrollbar{display:none}
.ftbtn{padding:5px 10px;border-radius:var(--radius-xs);font-size:9px;font-weight:700;font-family:inherit;
  cursor:pointer;letter-spacing:.03em;border:1px solid var(--border);background:var(--surface);color:var(--dim);
  transition:all .25s;display:flex;align-items:center;gap:4px;touch-action:manipulation;white-space:nowrap;flex-shrink:0}
.ftbtn.on{border-color:var(--blue);color:var(--blue);background:rgba(56,189,248,.06);
  box-shadow:0 0 12px rgba(56,189,248,.08)}
.ftbtn .fdot{width:5px;height:5px;border-radius:50%;background:var(--dim);transition:all .25s}
.ftbtn.on .fdot{background:var(--blue);box-shadow:0 0 8px var(--blue)}

/* ‚îÄ‚îÄ SVG CONTAINER ‚îÄ‚îÄ */
.svgw{background:var(--glass);border:1px solid var(--glass-border);border-radius:var(--radius);
  padding:4px;position:relative;overflow-x:auto;overflow-y:hidden;-webkit-overflow-scrolling:touch;
  backdrop-filter:blur(16px);box-shadow:0 8px 32px rgba(0,0,0,.3),inset 0 1px 0 rgba(255,255,255,.03)}
.svgw::before{content:'';position:absolute;top:0;left:0;right:0;height:1px;
  background:linear-gradient(90deg,transparent,rgba(255,255,255,.06),transparent);z-index:2;pointer-events:none}
#mainSvg{width:100%;height:auto;display:block;min-width:700px}

/* Scroll hint for mobile */
.scroll-hint{display:none;text-align:center;font-size:10px;color:var(--muted);padding:6px;letter-spacing:.04em;
  animation:fadeHint 3s ease-in-out infinite}
@keyframes fadeHint{0%,100%{opacity:.4}50%{opacity:.8}}

/* ‚îÄ‚îÄ Control Panel (under network, same on all devices) ‚îÄ‚îÄ */
.ctrl-panel{display:flex;flex-direction:column;align-items:center;gap:3px;padding:4px 6px;margin:4px auto 0}
.ctrl-row{display:flex;justify-content:center;gap:3px;width:100%;padding:0 4px}
.ctrl-ch{flex:1;height:30px;border-radius:6px;border:2px solid;
  font-size:10px;font-weight:800;font-family:inherit;cursor:pointer;transition:all .15s;
  touch-action:manipulation;-webkit-tap-highlight-color:transparent;display:flex;
  align-items:center;justify-content:center;padding:0}
.ctrl-ch.on{box-shadow:0 0 10px currentColor;transform:scale(1.05)}
.ctrl-ch.off{opacity:.2}
.ctrl-dd-wrap{flex:1;position:relative}
.ctrl-dd{width:100%;height:30px;background:var(--bg);border:2px solid;border-radius:6px;
  font-size:11px;font-weight:800;font-family:inherit;text-align:center;cursor:pointer;padding:0;
  touch-action:manipulation;-webkit-tap-highlight-color:transparent;-webkit-appearance:none;appearance:none;
  color-scheme:dark}
.ctrl-dd-arrow{position:absolute;right:3px;top:50%;transform:translateY(-55%);font-size:14px;pointer-events:none;line-height:1}
.ctrl-dd:disabled{opacity:.3}
.ctrl-dd option{background:var(--bg);color:var(--text)}
.ctrl-lk{flex:1;height:26px;border:1px solid #475569;background:var(--surface);cursor:pointer;font-size:11px;
  border-radius:5px;display:flex;align-items:center;justify-content:center;padding:0;touch-action:manipulation;transition:all .15s}
.ctrl-lk.on{border-color:var(--yellow);background:rgba(250,204,21,.08)}
@media(max-width:380px){.ctrl-ch{height:28px;font-size:9px}.ctrl-dd{height:28px;font-size:10px}.ctrl-lk{height:24px;font-size:10px}}

/* ‚îÄ‚îÄ LEGEND BAR ‚îÄ‚îÄ */
.lbar{display:flex;gap:8px;margin-top:10px;flex-wrap:wrap}
.litem{flex:1;min-width:140px;background:var(--glass);border:1px solid var(--glass-border);border-radius:var(--radius-sm);
  padding:8px 12px;font-size:10px;backdrop-filter:blur(12px)}
.litem .ll{color:var(--muted);font-weight:700;letter-spacing:.08em}

/* ‚îÄ‚îÄ MONITOR PANEL ‚îÄ‚îÄ */
.mpanel{display:none;margin-top:12px}
.mpanel.show{display:block}
.card{background:var(--glass);border:1px solid var(--glass-border);border-radius:var(--radius);padding:14px;
  position:relative;overflow:hidden;backdrop-filter:blur(16px);box-shadow:0 4px 24px rgba(0,0,0,.2)}
.card::before{content:'';position:absolute;top:0;left:0;right:0;height:1px;
  background:linear-gradient(90deg,transparent,rgba(255,255,255,.06),transparent)}
.ctitle{font-size:10px;font-weight:700;color:var(--muted);letter-spacing:.1em;text-transform:uppercase;margin-bottom:10px}

.mgrid{display:grid;grid-template-columns:repeat(4,1fr);gap:6px}
.mcell{background:var(--surface);border:1px solid var(--border);border-radius:var(--radius-sm);padding:10px 6px;text-align:center;
  transition:border-color .3s,box-shadow .3s}
.mcell .mch{font-size:9px;font-weight:700;margin-bottom:4px;letter-spacing:.06em}
.mbar{width:100%;height:5px;border-radius:3px;background:var(--bg);overflow:hidden;margin:4px 0}
.mbar-fill{height:100%;border-radius:3px;transition:width .4s}

/* ‚îÄ‚îÄ FOCUS OVERLAY ‚îÄ‚îÄ */
.focus-overlay{position:fixed;inset:0;background:var(--bg);z-index:8000;display:none;flex-direction:column;align-items:center;padding:16px;overflow-y:auto;-webkit-overflow-scrolling:touch}
.focus-overlay.show{display:flex}
.fo-header{text-align:center;margin-bottom:10px;padding-top:16px}
.fo-header h2{font-family:'Outfit',sans-serif;font-size:clamp(16px,4.5vw,22px);font-weight:800;color:var(--text);letter-spacing:.04em}
.fo-header .fo-sub{font-size:clamp(9px,2.5vw,11px);color:var(--muted);margin-top:6px;line-height:1.5;padding:0 8px}
.fo-legend{display:flex;gap:8px;flex-wrap:wrap;justify-content:center;margin-bottom:12px;padding:0 8px}
.fo-leg-item{font-size:10px;display:flex;align-items:center;gap:5px;white-space:nowrap}
.fo-leg-dot{width:8px;height:8px;border-radius:50%}
.fo-close{background:var(--glass);border:1px solid var(--glass-border);color:var(--muted);
  font-size:12px;font-family:inherit;font-weight:700;padding:10px 28px;border-radius:var(--radius-sm);cursor:pointer;
  backdrop-filter:blur(16px);transition:all .2s;touch-action:manipulation}
.fo-close:hover,.fo-close:active{color:var(--text);border-color:var(--dim)}
.fo-actions{position:fixed;bottom:16px;left:0;right:0;z-index:8010;display:flex;justify-content:space-between;padding:0 16px;pointer-events:none;margin:0}
.fo-actions .fo-close{pointer-events:auto}
.fo-svg-wrap.compact #focusSvg{min-width:unset;width:100%;display:block}
.fo-svg-wrap.compact{overflow-x:hidden;padding:4px}
.fo-svg-wrap{width:100%;max-width:1400px;background:var(--glass);border:1px solid var(--glass-border);border-radius:var(--radius);
  padding:12px;overflow-x:auto;-webkit-overflow-scrolling:touch;backdrop-filter:blur(16px)}
#focusSvg{width:100%;height:auto;display:block;min-width:700px}
.fo-hint{text-align:center;font-size:11px;color:var(--muted);margin-top:10px;letter-spacing:.03em}

/* ‚îÄ‚îÄ MODAL ‚îÄ‚îÄ */
.mo{position:fixed;inset:0;background:rgba(0,0,0,.85);backdrop-filter:blur(16px);display:none;align-items:center;justify-content:center;z-index:9999;padding:16px}
.mo.show{display:flex}
.mbox{background:linear-gradient(180deg,#1a1428,#100d1c);border:2px solid var(--red);border-radius:20px;
  padding:24px;max-width:500px;width:100%;box-shadow:0 0 80px rgba(248,113,113,.2),0 24px 48px rgba(0,0,0,.5);
  animation:pop .25s ease-out;max-height:90vh;overflow-y:auto}
@keyframes pop{from{transform:scale(.92);opacity:0}to{transform:scale(1);opacity:1}}
.micon{width:56px;height:56px;border-radius:50%;margin:0 auto 12px;display:flex;align-items:center;justify-content:center;
  background:radial-gradient(circle,rgba(248,113,113,.18),transparent 70%);border:2px solid var(--red);font-size:26px;
  box-shadow:0 0 24px rgba(248,113,113,.25)}
.mtitle{font-family:'Outfit',sans-serif;font-size:18px;font-weight:700;color:var(--red);text-align:center;letter-spacing:.05em;margin-bottom:6px}
.mdesc{font-size:12px;color:#cbd5e1;text-align:center;line-height:1.6;margin-bottom:14px}
.mdet{background:var(--bg);border-radius:12px;padding:12px 14px;margin-bottom:14px;border:1px solid var(--border)}
.msl{font-size:10px;font-weight:700;letter-spacing:.1em;margin-bottom:8px}
.mchips{display:flex;flex-wrap:wrap;gap:6px;margin-bottom:10px}
.mchip{padding:5px 12px;border-radius:6px;font-weight:700;font-size:11px;border:1px solid}
.mwarn{font-size:11px;color:var(--orange);text-align:center;margin-bottom:16px;line-height:1.6;
  padding:12px 14px;background:rgba(251,146,60,.04);border-radius:var(--radius-xs);border:1px solid rgba(251,146,60,.18)}
.macts{display:flex;gap:10px}
.macts button{flex:1;padding:14px;border-radius:var(--radius-xs);font-size:12px;font-weight:700;font-family:inherit;
  cursor:pointer;letter-spacing:.03em;touch-action:manipulation;transition:all .2s}
.mcancel{background:var(--card);color:#94a3b8;border:1px solid var(--dim)}
.mforce{background:linear-gradient(135deg,var(--red),var(--orange));color:var(--bg);border:none;
  box-shadow:0 4px 20px rgba(248,113,113,.25)}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   MOBILE RESPONSIVE
   ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */

/* Phones */
@media(max-width:640px){
  .dash{padding:12px 4px 28px}
  .header{margin-bottom:12px;padding:6px 0 16px}
  
  /* Stack control bar vertically */
  .cbar{gap:6px;flex-direction:column;align-items:stretch}
  .cbar-section{padding:6px 10px;justify-content:center}
  #presetsBar{width:100%;gap:5px}
  
  /* Feature toggles: single row, scroll if needed */
  .ftbar{gap:4px;padding:0 2px;justify-content:flex-start}
  .ftbtn{padding:5px 8px;font-size:8px;gap:3px}

  /* SVG needs scroll */
  .scroll-hint{display:block}
  
  /* Monitor: 2 columns */
  .mgrid{grid-template-columns:repeat(2,1fr);gap:5px}
  .mcell{padding:8px 5px}
  
  /* Legend: stack */
  .lbar{gap:6px}
  .litem{min-width:100%;font-size:9px;padding:6px 10px}
  
  /* Modal */
  .mbox{padding:20px 16px}
  .macts{flex-direction:column;gap:8px}
  .macts button{padding:14px}
  
  /* Focus overlay */
  .fo-header{padding-top:12px}
  .fo-legend{gap:6px}
  .fo-leg-item{font-size:9px}
}

/* Small phones */
@media(max-width:380px){
  .dash{padding:8px 2px 24px}
  .pill{padding:5px 10px;font-size:10px}
  .pbtn{padding:5px 8px;font-size:10px}
  .ftbtn{padding:4px 6px;font-size:7px}
  .cbar-section{padding:5px 8px}
}

/* Tablets */
@media(min-width:641px) and (max-width:1024px){
  .mgrid{grid-template-columns:repeat(4,1fr)}
  .dash{padding:16px 16px 36px}
}

/* Desktop */
@media(min-width:1025px){
  .dash{padding:20px 24px 40px}
  .mgrid{grid-template-columns:repeat(8,1fr)}
  #mainSvg{min-width:unset}
  #focusSvg{min-width:unset}
  .scroll-hint{display:none !important}
}

/* Touch device improvements */
@media(hover:none){
  .pbtn:hover{background:var(--surface);color:var(--muted);border-color:var(--border);transform:none}
  .pbtn:active{background:var(--card);color:var(--text);border-color:var(--dim)}
}

/* Safe area for notched phones */
@supports(padding-bottom:env(safe-area-inset-bottom)){
  .dash{padding-bottom:calc(32px + env(safe-area-inset-bottom))}
}

/* Smooth scrollbar styling */
.svgw::-webkit-scrollbar,.fo-svg-wrap::-webkit-scrollbar{height:4px}
.svgw::-webkit-scrollbar-track,.fo-svg-wrap::-webkit-scrollbar-track{background:transparent}
.svgw::-webkit-scrollbar-thumb,.fo-svg-wrap::-webkit-scrollbar-thumb{background:var(--dim);border-radius:4px}

/* ‚îÄ‚îÄ CHANNEL SELECTOR STRIP ‚îÄ‚îÄ */
.svgw.compact #mainSvg{min-width:unset;width:100%;display:block}
.svgw.compact{overflow-x:hidden;padding:4px}

/* ‚îÄ‚îÄ PATH ANIMATION ‚îÄ‚îÄ */
.path-anim{animation:drawPath .8s ease-out forwards}
@keyframes drawPath{from{stroke-dashoffset:2000}to{stroke-dashoffset:0}}
#mainSvg{transition:opacity .15s ease-out}
#mainSvg.transitioning{opacity:.3}

/* ‚îÄ‚îÄ FULLSCREEN ‚îÄ‚îÄ */
.svgw:fullscreen,.svgw:-webkit-full-screen{background:var(--bg);display:flex;align-items:center;justify-content:center;padding:16px;overflow:hidden}
.svgw:fullscreen #mainSvg,.svgw:-webkit-full-screen #mainSvg{min-width:unset;width:100%;height:auto;max-height:100%}
.fs-exit{display:none;position:absolute;top:12px;right:12px;z-index:100;background:rgba(12,17,32,.92);
  border:1px solid #445;color:#e2e8f0;font-size:13px;font-family:inherit;font-weight:700;
  padding:12px 24px;border-radius:10px;cursor:pointer;touch-action:manipulation}
.fs-exit:hover,.fs-exit:active{background:rgba(20,25,45,.95);border-color:#667}
.svgw:fullscreen .fs-exit,.svgw:-webkit-full-screen .fs-exit{display:block}

/* ‚îÄ‚îÄ TOAST NOTIFICATION ‚îÄ‚îÄ */
.toast{position:fixed;bottom:24px;left:50%;transform:translateX(-50%) translateY(80px);background:var(--card);
  border:1px solid var(--glass-border);color:var(--text);font-size:11px;font-family:inherit;font-weight:600;
  padding:10px 20px;border-radius:var(--radius-sm);backdrop-filter:blur(16px);z-index:9999;
  transition:transform .3s ease-out;pointer-events:none;white-space:nowrap}
.toast.show{transform:translateX(-50%) translateY(0)}

/* ‚îÄ‚îÄ STANDALONE / FULLSCREEN MODE ‚îÄ‚îÄ */
@media(display-mode:standalone),@media(display-mode:fullscreen){
  .dash{padding-top:env(safe-area-inset-top,0)}
}
html,body{overscroll-behavior:none}

/* ‚îÄ‚îÄ SPLASH SCREEN ‚îÄ‚îÄ */
.splash{position:fixed;inset:0;z-index:99999;background:var(--bg);display:flex;flex-direction:column;
  align-items:center;justify-content:center;transition:opacity .6s ease-out}
.splash.hide{opacity:0;pointer-events:none}
.splash-title{font-family:'Outfit',sans-serif;font-size:22px;font-weight:800;letter-spacing:.08em;
  color:var(--text);margin-bottom:6px;opacity:0;animation:splashFadeIn .6s .2s ease-out forwards}
.splash-sub{font-size:11px;color:var(--muted);letter-spacing:.06em;opacity:0;animation:splashFadeIn .6s .5s ease-out forwards}
.splash-svg{width:280px;height:160px;margin-bottom:24px}
.splash-svg line,.splash-svg circle{opacity:0}
.splash-line{animation:splashDraw .5s ease-out forwards}
.splash-dot{animation:splashPop .3s ease-out forwards}
.splash-bar{width:120px;height:2px;background:var(--border);border-radius:2px;margin-top:20px;overflow:hidden;
  opacity:0;animation:splashFadeIn .4s .3s ease-out forwards}
.splash-bar-fill{width:0;height:100%;border-radius:2px;background:linear-gradient(90deg,#818cf8,#38bdf8,#4ade80);
  animation:splashLoad 1.6s .5s ease-in-out forwards}
@keyframes splashFadeIn{to{opacity:1}}
@keyframes splashDraw{from{opacity:0;stroke-dashoffset:200}to{opacity:.8;stroke-dashoffset:0}}
@keyframes splashPop{from{opacity:0;r:0}to{opacity:1;r:4}}
@keyframes splashLoad{to{width:100%}}

/* ‚îÄ‚îÄ LANDSCAPE SIDE-BY-SIDE ‚îÄ‚îÄ */
@media(orientation:landscape) and (max-height:500px){
  .dash{padding:4px}
  .header{margin-bottom:2px;padding:2px 0 4px}
  .header h1{font-size:13px}
  .sub{font-size:7px}
  .sbar{margin-bottom:2px}
  .cbar{margin-bottom:2px}
  .ftbar{margin-bottom:2px}
  .lbar{display:none}
  .scroll-hint{display:none}
  .ctrl-panel{display:none!important}
  .focus-overlay{padding:0;overflow:hidden}
  .focus-overlay .fo-header{display:none}
  .focus-overlay .fo-legend{display:none}
  .focus-overlay .fo-actions{position:fixed;bottom:8px;left:0;right:0;padding:0 8px;z-index:8010;margin:0}
  .fo-svg-wrap{padding:0!important;border:none!important;border-radius:0!important;
    background:transparent!important;height:100vh;height:100dvh;display:flex;align-items:center;justify-content:center}
  .fo-svg-wrap #focusSvg{min-width:unset!important;width:100%!important;height:100vh!important;height:100dvh!important;object-fit:contain}
}
@media(orientation:landscape) and (min-height:501px) and (max-height:800px){
  .dash{padding:6px}
  .header{margin-bottom:4px}
  .lbar{display:none}
  .scroll-hint{display:none}
  .ctrl-panel{display:none!important}
  .focus-overlay{padding:4px;overflow:hidden}
  .focus-overlay .fo-header{display:none}
  .focus-overlay .fo-legend{display:none}
  .focus-overlay .fo-actions{position:fixed;bottom:8px;left:0;right:0;padding:0 10px;z-index:8010;margin:0}
  .fo-svg-wrap{padding:4px!important;border:none!important;border-radius:0!important;
    background:transparent!important;height:100vh;height:100dvh;display:flex;align-items:center;justify-content:center}
  .fo-svg-wrap #focusSvg{min-width:unset!important;width:100%!important;height:100vh!important;height:100dvh!important;object-fit:contain}
}
</style>
</head>
<body>

<!-- Splash Screen -->
<div class="splash" id="splash">
  <svg class="splash-svg" viewBox="0 0 280 160">
    <line x1="30" y1="30" x2="250" y2="30" stroke="#f87171" stroke-width="2" stroke-dasharray="200" class="splash-line" style="animation-delay:.1s"/>
    <line x1="30" y1="60" x2="250" y2="60" stroke="#facc15" stroke-width="2" stroke-dasharray="200" class="splash-line" style="animation-delay:.2s"/>
    <line x1="30" y1="90" x2="250" y2="90" stroke="#4ade80" stroke-width="2" stroke-dasharray="200" class="splash-line" style="animation-delay:.3s"/>
    <line x1="30" y1="120" x2="250" y2="120" stroke="#38bdf8" stroke-width="2" stroke-dasharray="200" class="splash-line" style="animation-delay:.4s"/>
    <line x1="70" y1="30" x2="130" y2="60" stroke="#fb923c" stroke-width="1.5" stroke-dasharray="200" class="splash-line" style="animation-delay:.5s" opacity=".5"/>
    <line x1="130" y1="60" x2="190" y2="30" stroke="#818cf8" stroke-width="1.5" stroke-dasharray="200" class="splash-line" style="animation-delay:.6s" opacity=".5"/>
    <line x1="70" y1="90" x2="130" y2="120" stroke="#c084fc" stroke-width="1.5" stroke-dasharray="200" class="splash-line" style="animation-delay:.7s" opacity=".5"/>
    <line x1="130" y1="120" x2="190" y2="90" stroke="#f472b6" stroke-width="1.5" stroke-dasharray="200" class="splash-line" style="animation-delay:.8s" opacity=".5"/>
    <circle cx="70" cy="30" fill="#f87171" class="splash-dot" style="animation-delay:.3s"/>
    <circle cx="130" cy="30" fill="#f87171" class="splash-dot" style="animation-delay:.5s"/>
    <circle cx="190" cy="30" fill="#f87171" class="splash-dot" style="animation-delay:.7s"/>
    <circle cx="70" cy="60" fill="#facc15" class="splash-dot" style="animation-delay:.4s"/>
    <circle cx="130" cy="60" fill="#facc15" class="splash-dot" style="animation-delay:.6s"/>
    <circle cx="190" cy="60" fill="#facc15" class="splash-dot" style="animation-delay:.8s"/>
    <circle cx="70" cy="90" fill="#4ade80" class="splash-dot" style="animation-delay:.5s"/>
    <circle cx="130" cy="90" fill="#4ade80" class="splash-dot" style="animation-delay:.7s"/>
    <circle cx="190" cy="90" fill="#4ade80" class="splash-dot" style="animation-delay:.9s"/>
    <circle cx="70" cy="120" fill="#38bdf8" class="splash-dot" style="animation-delay:.6s"/>
    <circle cx="130" cy="120" fill="#38bdf8" class="splash-dot" style="animation-delay:.8s"/>
    <circle cx="190" cy="120" fill="#38bdf8" class="splash-dot" style="animation-delay:1s"/>
    <rect x="55" y="20" width="30" height="20" rx="6" fill="none" stroke="#475569" stroke-width="1" opacity=".4" class="splash-line" style="animation-delay:.35s"/>
    <rect x="115" y="20" width="30" height="20" rx="6" fill="none" stroke="#475569" stroke-width="1" opacity=".4" class="splash-line" style="animation-delay:.55s"/>
    <rect x="175" y="20" width="30" height="20" rx="6" fill="none" stroke="#475569" stroke-width="1" opacity=".4" class="splash-line" style="animation-delay:.75s"/>
    <rect x="55" y="80" width="30" height="20" rx="6" fill="none" stroke="#475569" stroke-width="1" opacity=".4" class="splash-line" style="animation-delay:.55s"/>
    <rect x="115" y="80" width="30" height="20" rx="6" fill="none" stroke="#475569" stroke-width="1" opacity=".4" class="splash-line" style="animation-delay:.75s"/>
    <rect x="175" y="80" width="30" height="20" rx="6" fill="none" stroke="#475569" stroke-width="1" opacity=".4" class="splash-line" style="animation-delay:.95s"/>
  </svg>
  <div class="splash-title">DILATED BENE≈†</div>
  <div class="splash-sub">8√ó8 Photonic Switch Network</div>
  <div class="splash-bar"><div class="splash-bar-fill"></div></div>
</div>

<div class="dash" id="mainDash" style="opacity:0">
  <div class="header"><h1>8√ó8 Dilated Bene≈° Network</h1><div class="sub">48 MZI Switches ¬∑ 6 Stages √ó 8 ¬∑ XOR-Stride [4,2,1,2,4] ¬∑ Strictly Non-Blocking</div></div>
  <div class="sbar" id="statusBar"></div>
  <div class="cbar">
    <div class="cbar-section" id="presetsBar"><span class="cbar-lbl">PRESETS</span></div>
    <div class="cbar-section"><button class="rbtn off" id="rerouteBtn" onclick="handleReroute()">LOCK PATHS FIRST</button><span id="rerouteMsg"></span><button class="helpbtn" onclick="document.getElementById('helpBox').classList.toggle('show')">‚ìò Help</button></div>
    <div class="cbar-section"><button class="ftbtn on" onclick="openFocus()" style="border-color:var(--purple);color:var(--purple)"><span class="fdot" style="background:var(--purple)"></span>Network View</button><button class="ftbtn" id="compactBtn" onclick="toggleCompact()"><span class="fdot"></span>Fit Screen</button><button class="ftbtn" onclick="goFullscreen()"><span class="fdot"></span>Fullscreen</button></div>
  </div>
  <div class="helpbox" id="helpBox">üîí Click the <b>first box</b> to lock/unlock ¬∑ Click the <b>second box</b> to select output ¬∑ <b>‚ö° Reroute</b> reroutes unlocked around locked</div>
  <div class="ftbar">
    <button class="ftbtn on" onclick="toggleFeature('loss',this)"><span class="fdot"></span>Insertion Loss</button>
    <button class="ftbtn" onclick="toggleFeature('photon',this)"><span class="fdot"></span>Photon Flow</button>
    <button class="ftbtn" onclick="toggleFeature('xtalk',this)"><span class="fdot"></span>Crosstalk Map</button>
    <button class="ftbtn on" onclick="toggleFeature('monitor',this)"><span class="fdot"></span>Monitoring</button>
  </div>
  <div class="dash-main">
  <div class="dash-left">
  <div class="svgw" id="svgWrap">
    <svg id="mainSvg" viewBox="50 0 1120 580"></svg>
    <button class="fs-exit" id="fsExit" onclick="exitFullscreen()">‚úï Exit Fullscreen</button>
  </div>
  <div class="ctrl-panel" id="ctrlPanel"></div>
  <div class="scroll-hint">‚Üê Swipe to explore ¬∑ or tap <b>Fit Screen</b> above ‚Üí</div>
  <div class="lbar">
    <div class="litem"><span class="ll">SWITCHES: </span><span style="color:var(--text)">BAR ¬∑ CROSS ¬∑ </span><span style="color:var(--dim)">idle</span></div>
    <div class="litem"><span class="ll">WAVEGUIDES: </span><span style="color:#6a7490">‚îÑ topology ¬∑ </span><span style="color:var(--green)">‚îÅ active</span></div>
    <div class="litem"><span class="ll">INPUT: </span><span style="color:var(--yellow)">‚ñ°üîí lock</span> ¬∑ <span style="color:var(--blue)">‚ñ°‚ñæ output</span></div>
  </div>
  </div>
  <div class="dash-right">
  <div class="mpanel show" id="monitorPanel">
    <div class="card"><div class="ctitle">Real-Time Port Monitoring ‚Äî Power ¬∑ BER ¬∑ OSNR</div><div class="mgrid" id="monGrid"></div></div>
  </div>
  </div>
  </div>
</div>

<!-- Focus / Network View -->
<div class="focus-overlay" id="focusOverlay">
  <div class="fo-header">
    <h2>Dilated Bene≈° 8√ó8 ‚Äî Network Architecture</h2>
    <div class="fo-sub">Recursive butterfly topology ¬∑ 6 stages √ó 8 rows = 48 MZI switches ¬∑ Each switch routes to row r (bar) or r‚äïstride (cross)</div>
  </div>
  <div class="fo-legend" id="focusLegend"></div>
  <div class="fo-actions">
    <button class="fo-close fo-btn-left" onclick="closeFocus()">‚úï Close</button>
    <button class="fo-close fo-btn-right" id="foCompactBtn" onclick="toggleFocusCompact()">‚õ∂ Fit Screen</button>
  </div>
  <div class="fo-svg-wrap" id="focusWrap"><svg id="focusSvg" viewBox="0 0 1300 680"></svg></div>
</div>

<!-- Conflict modal -->
<div class="mo" id="modal" onclick="closeModal()"><div class="mbox" onclick="event.stopPropagation()"><div class="micon">‚ö†Ô∏è</div><div class="mtitle">ROUTING CONFLICT</div><div class="mdesc">Cannot route all signals while keeping locked paths frozen.</div><div class="mdet"><div class="msl" style="color:var(--red)">‚úó FAILED TO ROUTE</div><div class="mchips" id="failedChips"></div><div class="msl" style="color:var(--yellow)">üîí LOCKED PATHS BLOCKING</div><div class="mchips" id="lockedChips"></div></div><div class="mwarn">Locked paths must be <strong style="color:var(--red);font-size:14px">UNLOCKED &amp; REARRANGED</strong></div><div class="macts"><button class="mcancel" onclick="closeModal()">CANCEL</button><button class="mforce" onclick="handleForceReroute()">üîì UNLOCK ALL &amp; REROUTE</button></div></div></div>

<div class="toast" id="toast"></div>

<script>
var N=8,STAGES=6,STRIDES=[4,2,1,2,4];
var COLORS=['#f87171','#fb923c','#facc15','#4ade80','#38bdf8','#818cf8','#c084fc','#f472b6'];
var perm=[7,6,5,4,3,2,1,0],locked=Array(N).fill(false),frozenRoutes=Array(N).fill(null);
var highlight=new Set(),routes=Array(N).fill(null),pathData=[],switchUsage={};
function isHL(i){return highlight.size===0||highlight.has(i)}
function toggleHL(i){if(highlight.has(i))highlight.delete(i);else highlight.add(i)}
var features={loss:true,photon:false,xtalk:false,monitor:true};
function toggleFeature(f,btn){features[f]=!features[f];btn.classList.toggle('on');
  if(f==='monitor')document.getElementById('monitorPanel').classList.toggle('show',features.monitor);renderSVG()}

var animatePaths=false;

var compactMode=false;
function toggleCompact(){
  compactMode=!compactMode;
  var wrap=document.getElementById('svgWrap');
  var btn=document.getElementById('compactBtn');
  var hint=document.querySelector('.scroll-hint');
  wrap.classList.toggle('compact',compactMode);
  btn.classList.toggle('on',compactMode);
  if(hint){hint.style.display=compactMode?'none':''}
  setTimeout(function(){buildCtrlPanel()},50);
}

var focusCompact=false;
function toggleFocusCompact(){
  focusCompact=!focusCompact;
  var wrap=document.getElementById('focusWrap');
  var btn=document.getElementById('foCompactBtn');
  wrap.classList.toggle('compact',focusCompact);
  btn.style.borderColor=focusCompact?'var(--blue)':'';
  btn.style.color=focusCompact?'var(--blue)':'';
}

// ‚îÄ‚îÄ Layout ‚îÄ‚îÄ
var SVG_W=1300,SVG_H=580,SW_W=60,SW_H=36,PG=14;
var STAGE_X=[140,300,470,650,820,990];
var SWY=[];for(var i=0;i<8;i++)SWY[i]=52+i*67;

function yTop(sw){return SWY[sw]-PG/2}
function yBot(sw){return SWY[sw]+PG/2}
function yPort(sw,p){return p==='top'?yTop(sw):yBot(sw)}

// ‚îÄ‚îÄ Connections ‚îÄ‚îÄ
var connTable=[],connLookup={};
(function(){for(var s=0;s<5;s++){var d=STRIDES[s],raw=[];
  for(var r=0;r<8;r++){var sD=r,cD=r^d,sP,cP;
    if(SWY[sD]<=SWY[cD]){sP='top';cP='bot'}else{sP='bot';cP='top'}
    raw.push({stage:s,srcSw:r,srcPort:sP,destSw:sD,type:'bar'});
    raw.push({stage:s,srcSw:r,srcPort:cP,destSw:cD,type:'cross'})}
  var bd={};raw.forEach(function(c){if(!bd[c.destSw])bd[c.destSw]=[];bd[c.destSw].push(c)});
  for(var dw in bd){var a=bd[dw];a.sort(function(a,b){return yPort(a.srcSw,a.srcPort)-yPort(b.srcSw,b.srcPort)});a[0].destPort='top';if(a[1])a[1].destPort='bot'}
  raw.forEach(function(c){connTable.push(c);connLookup[s+'-'+c.srcSw+'-'+c.type]=c})}})();

// ‚îÄ‚îÄ Routing ‚îÄ‚îÄ
function routeAll(pm,pre){var used={},res=Array(N).fill(null);
  if(pre)for(var i=0;i<N;i++)if(pre[i]){res[i]=pre[i];pre[i].switches.forEach(function(s){used[s]=1})}
  var todo=[];for(var i=0;i<N;i++)if(!res[i])todo.push(i);var ar={};
  for(var ti=0;ti<todo.length;ti++){var sig=todo[ti];ar[sig]=[];
    for(var c=0;c<32;c++){var pos=sig,ch=[],sw=[];
      for(var s=0;s<6;s++){sw.push(s+'-'+pos);if(s<5){var cr=Boolean((c>>s)&1);ch.push(cr);if(cr)pos^=STRIDES[s]}}
      if(pos===pm[sig])ar[sig].push({choices:ch,switches:sw})}}
  function solve(idx){if(idx===todo.length)return true;var sig=todo[idx];
    for(var ri=0;ri<ar[sig].length;ri++){var r=ar[sig][ri],bad=false;
      for(var j=0;j<r.switches.length;j++)if(used[r.switches[j]]){bad=true;break}
      if(bad)continue;r.switches.forEach(function(s){used[s]=1});res[sig]=r;
      if(solve(idx+1))return true;r.switches.forEach(function(s){delete used[s]});res[sig]=null}return false}
  solve(0);return res}
function trace(inp,route){if(!route)return null;var pos=[],p=inp;
  for(var s=0;s<6;s++){var cr=(s<5)?route.choices[s]:false;pos.push({stage:s,sw:p,cross:cr});if(s<5&&cr)p^=STRIDES[s]}
  return{positions:pos,output:p}}
function compute(){var pre=Array(N).fill(null);for(var i=0;i<N;i++)if(locked[i]&&frozenRoutes[i])pre[i]=frozenRoutes[i];
  routes=routeAll(perm,pre);pathData=routes.map(function(r,i){return r?trace(i,r):null});
  switchUsage={};pathData.forEach(function(pd,i){if(pd)pd.positions.forEach(function(p){switchUsage[p.stage+'-'+p.sw]=i})})}

// ‚îÄ‚îÄ Models ‚îÄ‚îÄ
var IL_BAR=0.5,IL_CROSS=0.8,IL_WG=0.15;
function calcLoss(idx){if(!pathData[idx])return null;var pd=pathData[idx],loss=0;
  for(var s=0;s<6;s++){loss+=pd.positions[s].cross?IL_CROSS:IL_BAR;if(s<5)loss+=IL_WG}return Math.round(loss*100)/100}
function findCrosstalk(){var risks=[];
  for(var s=0;s<5;s++){var segs=[];
    for(var idx=0;idx<N;idx++){if(!pathData[idx])continue;var p=pathData[idx].positions[s];
      var ct=p.cross?'cross':'bar',cn=connLookup[s+'-'+p.sw+'-'+ct];if(cn)segs.push({sig:idx,src:p.sw,dst:cn.destSw,stage:s})}
    for(var a=0;a<segs.length;a++)for(var b=a+1;b<segs.length;b++){
      var sa=segs[a],sb=segs[b],sd=Math.abs(sa.src-sb.src),dd=Math.abs(sa.dst-sb.dst);
      if(sd<=1||dd<=1){var risk=(sd===0||dd===0)?'high':'medium';
        risks.push({s1:sa.sig,s2:sb.sig,stage:s,risk:risk,x1:STAGE_X[s]+SW_W,x2:STAGE_X[s+1],
          y1:SWY[Math.min(sa.src,sb.src)],y2:SWY[Math.max(sa.dst,sb.dst)]})}}}return risks}

// ‚îÄ‚îÄ Path building ‚îÄ‚îÄ
function traceSignal(idx){var pd=pathData[idx];if(!pd)return null;var pts=[];
  var sw0=pd.positions[0].sw;pts.push({x:110,y:yTop(sw0)});pts.push({x:STAGE_X[0],y:yTop(sw0),t:'L'});
  for(var s=0;s<5;s++){var p=pd.positions[s],cx=STAGE_X[s],ct=p.cross?'cross':'bar',cn=connLookup[s+'-'+p.sw+'-'+ct];
    pts.push({x:cx+SW_W,y:yPort(p.sw,cn.srcPort),t:'L'});
    var ns=pd.positions[s+1].sw;pts.push({x:STAGE_X[s+1],y:yPort(ns,cn.destPort),t:'C',fx:cx+SW_W,fy:yPort(p.sw,cn.srcPort)})}
  pts.push({x:STAGE_X[5]+SW_W,y:yTop(pd.positions[5].sw),t:'L'});
  pts.push({x:STAGE_X[5]+SW_W+18,y:yTop(pd.positions[5].sw),t:'L'});return pts}
function buildPathD(idx){var pts=traceSignal(idx);if(!pts)return null;var d='M'+pts[0].x+','+pts[0].y;
  for(var pi=1;pi<pts.length;pi++){var pt=pts[pi];
    if(pt.t==='C'){var dx=(pt.x-pt.fx)*.42;d+=' C'+(pt.fx+dx)+','+pt.fy+' '+(pt.x-dx)+','+pt.y+' '+pt.x+','+pt.y}
    else d+=' L'+pt.x+','+pt.y}return d}

// ‚îÄ‚îÄ SVG helpers ‚îÄ‚îÄ
var NS='http://www.w3.org/2000/svg';
function el(tag,a){var e=document.createElementNS(NS,tag);for(var k in a){if(k==='text')e.textContent=a[k];else e.setAttribute(k,a[k])}return e}
function bezD(x1,y1,x2,y2){var d=(x2-x1)*.42;return'M'+x1+','+y1+' C'+(x1+d)+','+y1+' '+(x2-d)+','+y2+' '+x2+','+y2}

function drawSubnetBlocks(svg){var oP=20,iP=12;
  function blk(r1,r2,s1,s2,f,fo,st,so,sw){var y1=SWY[r1]-SW_H/2-oP,y2=SWY[r2]+SW_H/2+oP,x1=STAGE_X[s1]-oP,x2=STAGE_X[s2]+SW_W+oP;
    svg.appendChild(el('rect',{x:x1,y:y1,width:x2-x1,height:y2-y1,rx:12,fill:f,opacity:fo,stroke:st,'stroke-width':sw,'stroke-opacity':so}))}
  function iblk(r1,r2,s1,s2,f,fo,st,so,sw){var y1=SWY[r1]-SW_H/2-iP,y2=SWY[r2]+SW_H/2+iP,x1=STAGE_X[s1]-iP,x2=STAGE_X[s2]+SW_W+iP;
    svg.appendChild(el('rect',{x:x1,y:y1,width:x2-x1,height:y2-y1,rx:8,fill:f,opacity:fo,stroke:st,'stroke-width':sw,'stroke-opacity':so}))}
  function lbl(t,x,y,c,sz){svg.appendChild(el('text',{x:x,y:y,'text-anchor':'start',fill:c,'font-size':sz||9,'font-family':'Outfit,sans-serif','font-weight':700,'letter-spacing':'.08em',opacity:.55,text:t}))}
  blk(0,3,1,4,'#38bdf8',0.06,'#38bdf8',0.18,1.2);blk(4,7,1,4,'#fb923c',0.06,'#fb923c',0.18,1.2);
  lbl('4√ó4 UPPER',STAGE_X[1]-oP+6,SWY[0]-SW_H/2-oP+12,'#38bdf8');lbl('4√ó4 LOWER',STAGE_X[1]-oP+6,SWY[4]-SW_H/2-oP+12,'#fb923c');
  iblk(0,1,2,3,'#4ade80',0.08,'#4ade80',0.25,1);iblk(2,3,2,3,'#facc15',0.08,'#facc15',0.25,1);
  iblk(4,5,2,3,'#facc15',0.08,'#facc15',0.25,1);iblk(6,7,2,3,'#fb923c',0.08,'#fb923c',0.25,1);
  var ix=STAGE_X[2]-iP+4;lbl('2√ó2',ix,SWY[0]-SW_H/2-iP+10,'#4ade80',8);lbl('2√ó2',ix,SWY[2]-SW_H/2-iP+10,'#facc15',8);
  lbl('2√ó2',ix,SWY[4]-SW_H/2-iP+10,'#facc15',8);lbl('2√ó2',ix,SWY[6]-SW_H/2-iP+10,'#fb923c',8)}

function drawTopology(svg,thick){
  var w=thick?1.3:.9,op=thick?.5:.35,da=thick?'5 5':'4 4';
  for(var i=0;i<8;i++){
    svg.appendChild(el('line',{x1:110,y1:yTop(i),x2:STAGE_X[0],y2:yTop(i),stroke:'#4a5570','stroke-width':w,'stroke-dasharray':da,opacity:op}));
    svg.appendChild(el('line',{x1:STAGE_X[5]+SW_W,y1:yTop(i),x2:STAGE_X[5]+SW_W+60,y2:yTop(i),stroke:'#4a5570','stroke-width':w,'stroke-dasharray':da,opacity:op}))}
  for(var ci=0;ci<connTable.length;ci++){var c=connTable[ci];
    svg.appendChild(el('path',{d:bezD(STAGE_X[c.stage]+SW_W,yPort(c.srcSw,c.srcPort),STAGE_X[c.stage+1],yPort(c.destSw,c.destPort)),
      fill:'none',stroke:'#4a5570','stroke-width':w,'stroke-dasharray':da,opacity:op}))}
  for(var si=0;si<STAGES;si++)for(var sw=0;sw<8;sw++){var cx=STAGE_X[si],pt=yTop(sw),pb=yBot(sw);
    svg.appendChild(el('line',{x1:cx+10,y1:pt,x2:cx+SW_W-10,y2:pt,stroke:'#3a4560','stroke-width':thick?.8:.6,'stroke-dasharray':'3 3',opacity:thick?.35:.25}));
    svg.appendChild(el('line',{x1:cx+10,y1:pb,x2:cx+SW_W-10,y2:pb,stroke:'#3a4560','stroke-width':thick?.8:.6,'stroke-dasharray':'3 3',opacity:thick?.35:.25}));
    svg.appendChild(el('line',{x1:cx+10,y1:pt,x2:cx+SW_W-10,y2:pb,stroke:'#3a4560','stroke-width':thick?.6:.5,'stroke-dasharray':'2 4',opacity:thick?.2:.15}));
    svg.appendChild(el('line',{x1:cx+10,y1:pb,x2:cx+SW_W-10,y2:pt,stroke:'#3a4560','stroke-width':thick?.6:.5,'stroke-dasharray':'2 4',opacity:thick?.2:.15}))}}

function drawSwitches(svg,filterId,gradId){
  // Add electrode gradient to defs
  var defs=svg.querySelector('defs');
  if(defs&&!document.getElementById('elecGrad')){
    var eg=el('linearGradient',{id:'elecGrad',x1:'0',y1:'0',x2:'0',y2:'1'});
    eg.appendChild(el('stop',{offset:'0%','stop-color':'#c8a84e'}));
    eg.appendChild(el('stop',{offset:'50%','stop-color':'#a08030'}));
    eg.appendChild(el('stop',{offset:'100%','stop-color':'#c8a84e'}));
    defs.appendChild(eg);
    var eg2=el('linearGradient',{id:'elecGradDim',x1:'0',y1:'0',x2:'0',y2:'1'});
    eg2.appendChild(el('stop',{offset:'0%','stop-color':'#4a4530'}));
    eg2.appendChild(el('stop',{offset:'50%','stop-color':'#3a3520'}));
    eg2.appendChild(el('stop',{offset:'100%','stop-color':'#4a4530'}));
    defs.appendChild(eg2);
  }

  for(var si=0;si<STAGES;si++)for(var sw=0;sw<8;sw++){
    var cx=STAGE_X[si],cy=SWY[sw],key=si+'-'+sw,ub=switchUsage[key],u=ub!==undefined;
    var act=isHL(ub),col=u?COLORS[ub]:'#384050',lk=u&&locked[ub],op=u?(act?1:.1):.25;
    var g=el('g',{style:'cursor:pointer;transition:opacity .15s',opacity:op});
    var pt=yTop(sw),pb=yBot(sw),hh=SW_H/2,hw=SW_W;

    // Determine routing state
    var isBar=true,eP='top',xP='top';
    if(u){var sigPd=pathData[ub],stI=-1;
      for(var pi=0;pi<sigPd.positions.length;pi++)if(sigPd.positions[pi].stage===si){stI=pi;break}
      if(si>0){var pv=sigPd.positions[stI-1],pC=connLookup[(si-1)+'-'+pv.sw+'-'+(pv.cross?'cross':'bar')];if(pC)eP=pC.destPort}
      if(si<5){var cur=sigPd.positions[stI],cn=connLookup[si+'-'+cur.sw+'-'+(cur.cross?'cross':'bar')];xP=cn.srcPort}
      isBar=(eP===xP);
    }

    // ‚îÄ‚îÄ Outer border (glow + lock) ‚îÄ‚îÄ
    g.appendChild(el('rect',{x:cx-1,y:cy-hh-1,width:hw+2,height:SW_H+2,rx:7,fill:'none',stroke:col,
      'stroke-width':act&&highlight.size>0&&u?1.8:.5,opacity:.3,'stroke-dasharray':lk?'4 2':'none'}));
    if(act&&highlight.size>0&&u){
      g.appendChild(el('rect',{x:cx-1,y:cy-hh-1,width:hw+2,height:SW_H+2,rx:7,fill:'none',stroke:col,
        'stroke-width':3,opacity:.12,filter:'url(#'+filterId+ub+')'}));
    }
    // ‚îÄ‚îÄ Body fill ‚îÄ‚îÄ
    g.appendChild(el('rect',{x:cx,y:cy-hh,width:hw,height:SW_H,rx:6,fill:'url(#'+gradId+')',stroke:col,'stroke-width':.4}));

    // ‚îÄ‚îÄ Waveguide structure ‚îÄ‚îÄ
    var wc=u?col:'#2e3a50',wo=u?.28:.08;
    var ag=5.5; // arm gap from center
    var cL=cx+10,cR=cx+hw-10;

    // Input 2√ó2 coupler region (left MMI)
    g.appendChild(el('rect',{x:cL-2,y:cy-ag-1.5,width:5,height:ag*2+3,rx:1.5,
      fill:u?col+'08':'#151c2a',stroke:wc,'stroke-width':.4,opacity:u?.2:.06}));
    // Output 2√ó2 coupler region (right MMI)
    g.appendChild(el('rect',{x:cR-3,y:cy-ag-1.5,width:5,height:ag*2+3,rx:1.5,
      fill:u?col+'08':'#151c2a',stroke:wc,'stroke-width':.4,opacity:u?.2:.06}));

    // Input waveguides to left coupler
    g.appendChild(el('line',{x1:cx+2,y1:pt,x2:cL,y2:cy-ag,stroke:wc,'stroke-width':.8,opacity:wo,'stroke-linecap':'round'}));
    g.appendChild(el('line',{x1:cx+2,y1:pb,x2:cL,y2:cy+ag,stroke:wc,'stroke-width':.8,opacity:wo,'stroke-linecap':'round'}));
    // Top arm (between couplers)
    g.appendChild(el('line',{x1:cL+3,y1:cy-ag,x2:cR-3,y2:cy-ag,stroke:wc,'stroke-width':.8,opacity:wo}));
    // Bottom arm
    g.appendChild(el('line',{x1:cL+3,y1:cy+ag,x2:cR-3,y2:cy+ag,stroke:wc,'stroke-width':.8,opacity:wo}));
    // Output waveguides from right coupler
    g.appendChild(el('line',{x1:cR,y1:cy-ag,x2:cx+hw-2,y2:pt,stroke:wc,'stroke-width':.8,opacity:wo,'stroke-linecap':'round'}));
    g.appendChild(el('line',{x1:cR,y1:cy+ag,x2:cx+hw-2,y2:pb,stroke:wc,'stroke-width':.8,opacity:wo,'stroke-linecap':'round'}));

    // ‚îÄ‚îÄ 3 Electrodes (GSG) ‚Äî gold metallic pads ‚îÄ‚îÄ
    var eCx=cx+hw/2,eW=14,eHg=2,eHs=3,eGp=.8;
    var grdU=u?'url(#elecGrad)':'url(#elecGradDim)';
    var grdO=u?.55:.12;
    var gTopY=cy-ag-eHg-eGp;      // Ground top
    var sMidY=cy-eHs/2;            // Signal center
    var gBotY=cy+ag+eGp;           // Ground bottom

    // Ground pad (top) ‚Äî narrow
    g.appendChild(el('rect',{x:eCx-eW/2,y:gTopY,width:eW,height:eHg,rx:.8,
      fill:grdU,opacity:grdO,stroke:u?'#d4aa40':'#3a3520','stroke-width':.3}));
    // Bond wire stubs from ground top
    g.appendChild(el('line',{x1:eCx-eW/2+1,y1:gTopY,x2:eCx-eW/2-2,y2:gTopY-2,stroke:u?'#c8a84e':'#3a3520','stroke-width':.3,opacity:grdO*.6}));
    g.appendChild(el('line',{x1:eCx+eW/2-1,y1:gTopY,x2:eCx+eW/2+2,y2:gTopY-2,stroke:u?'#c8a84e':'#3a3520','stroke-width':.3,opacity:grdO*.6}));

    // Signal pad (center) ‚Äî taller, wider, brighter
    g.appendChild(el('rect',{x:eCx-eW/2-1,y:sMidY,width:eW+2,height:eHs,rx:1,
      fill:grdU,opacity:grdO*1.3,stroke:u?'#d4aa40':'#3a3520','stroke-width':.4}));
    // Active glow on signal electrode
    if(u&&act&&highlight.has(ub)){
      g.appendChild(el('rect',{x:eCx-eW/2-1,y:sMidY,width:eW+2,height:eHs,rx:1,
        fill:col,opacity:.12}));
    }
    // Vertical vias: signal pad to waveguide arms
    g.appendChild(el('line',{x1:eCx,y1:sMidY,x2:eCx,y2:cy-ag,
      stroke:u?'#c8a84e':'#2e3520','stroke-width':.5,opacity:grdO*.5,'stroke-dasharray':'1.5 1'}));
    g.appendChild(el('line',{x1:eCx,y1:sMidY+eHs,x2:eCx,y2:cy+ag,
      stroke:u?'#c8a84e':'#2e3520','stroke-width':.5,opacity:grdO*.5,'stroke-dasharray':'1.5 1'}));

    // Ground pad (bottom) ‚Äî narrow
    g.appendChild(el('rect',{x:eCx-eW/2,y:gBotY,width:eW,height:eHg,rx:.8,
      fill:grdU,opacity:grdO,stroke:u?'#d4aa40':'#3a3520','stroke-width':.3}));
    // Bond wire stubs from ground bottom
    g.appendChild(el('line',{x1:eCx-eW/2+1,y1:gBotY+eHg,x2:eCx-eW/2-2,y2:gBotY+eHg+2,stroke:u?'#c8a84e':'#3a3520','stroke-width':.3,opacity:grdO*.6}));
    g.appendChild(el('line',{x1:eCx+eW/2-1,y1:gBotY+eHg,x2:eCx+eW/2+2,y2:gBotY+eHg+2,stroke:u?'#c8a84e':'#3a3520','stroke-width':.3,opacity:grdO*.6}));

    // G-S-G tiny labels
    if(u){
      g.appendChild(el('text',{x:eCx+eW/2+3,y:gTopY+eHg,'font-size':3,fill:'#c8a84e',opacity:.22,'font-family':'inherit','font-weight':700,text:'G'}));
      g.appendChild(el('text',{x:eCx+eW/2+4,y:cy+1.5,'font-size':3.8,fill:'#c8a84e',opacity:.28,'font-family':'inherit','font-weight':800,text:'S'}));
      g.appendChild(el('text',{x:eCx+eW/2+3,y:gBotY+eHg,'font-size':3,fill:'#c8a84e',opacity:.22,'font-family':'inherit','font-weight':700,text:'G'}));
    }

    // ‚îÄ‚îÄ Active routing path (bright, thick, rounded) ‚îÄ‚îÄ
    if(u){
      var ey=yPort(sw,eP),xy=yPort(sw,xP);
      var armIn=ey<cy?cy-ag:cy+ag;
      var armOut=xy<cy?cy-ag:cy+ag;
      if(isBar){
        g.appendChild(el('path',{d:'M'+(cx+2)+','+ey+
          ' Q'+cL+','+ey+' '+cL+','+armIn+
          ' L'+cR+','+armIn+
          ' Q'+cR+','+xy+' '+(cx+hw-2)+','+xy,
          fill:'none',stroke:col,'stroke-width':2.4,opacity:.9,'stroke-linecap':'round','stroke-linejoin':'round'}));
      }else{
        g.appendChild(el('path',{d:'M'+(cx+2)+','+ey+
          ' Q'+cL+','+ey+' '+cL+','+armIn+
          ' L'+(eCx-4)+','+armIn+
          ' Q'+eCx+','+armIn+' '+eCx+','+cy+
          ' Q'+eCx+','+armOut+' '+(eCx+4)+','+armOut+
          ' L'+cR+','+armOut+
          ' Q'+cR+','+xy+' '+(cx+hw-2)+','+xy,
          fill:'none',stroke:col,'stroke-width':2.4,opacity:.9,'stroke-linecap':'round','stroke-linejoin':'round'}));
      }
      // Subtle glow behind active path
      if(act&&highlight.has(ub)){
        var pathD=isBar?
          'M'+(cx+2)+','+ey+' Q'+cL+','+ey+' '+cL+','+armIn+' L'+cR+','+armIn+' Q'+cR+','+xy+' '+(cx+hw-2)+','+xy:
          'M'+(cx+2)+','+ey+' Q'+cL+','+ey+' '+cL+','+armIn+' L'+(eCx-4)+','+armIn+' Q'+eCx+','+armIn+' '+eCx+','+cy+' Q'+eCx+','+armOut+' '+(eCx+4)+','+armOut+' L'+cR+','+armOut+' Q'+cR+','+xy+' '+(cx+hw-2)+','+xy;
        g.appendChild(el('path',{d:pathD,fill:'none',stroke:col,'stroke-width':5,opacity:.15,'stroke-linecap':'round','stroke-linejoin':'round'}));
      }
      g.appendChild(el('text',{x:cx+hw/2,y:cy+hh-1,'text-anchor':'middle',fill:col,'font-size':5.5,
        'font-family':'inherit','font-weight':800,'letter-spacing':'.08em',text:isBar?'BAR':'CROSS'}));
    }else{
      g.appendChild(el('text',{x:cx+hw/2,y:cy+3,'text-anchor':'middle',fill:'#252d40','font-size':5,
        'font-family':'inherit','font-weight':600,'letter-spacing':'.05em',text:'idle'}));
    }

    // ‚îÄ‚îÄ Half-circle ports (r=3.2) ‚îÄ‚îÄ
    var pr=3.2;
    g.appendChild(el('path',{d:'M'+cx+','+(pt-pr)+' A'+pr+','+pr+' 0 0,0 '+cx+','+(pt+pr),
      fill:u?col+'40':'#1e293b',stroke:u?col:'#384050','stroke-width':.8,opacity:.9}));
    g.appendChild(el('path',{d:'M'+cx+','+(pb-pr)+' A'+pr+','+pr+' 0 0,0 '+cx+','+(pb+pr),
      fill:u?col+'40':'#1e293b',stroke:u?col:'#384050','stroke-width':.8,opacity:.9}));
    g.appendChild(el('path',{d:'M'+(cx+hw)+','+(pt-pr)+' A'+pr+','+pr+' 0 0,1 '+(cx+hw)+','+(pt+pr),
      fill:u?col+'40':'#1e293b',stroke:u?col:'#384050','stroke-width':.8,opacity:.9}));
    g.appendChild(el('path',{d:'M'+(cx+hw)+','+(pb-pr)+' A'+pr+','+pr+' 0 0,1 '+(cx+hw)+','+(pb+pr),
      fill:u?col+'40':'#1e293b',stroke:u?col:'#384050','stroke-width':.8,opacity:.9}));

    if(u){(function(v){
      
      
      g.addEventListener('click',function(){toggleHL(v);renderSVG()});
    })(ub)}
    svg.appendChild(g)}}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  MAIN SVG RENDER
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function renderSVG(){
  var svg=document.getElementById('mainSvg');svg.innerHTML='';
  var defs=el('defs',{});
  for(var i=0;i<8;i++){var f=el('filter',{id:'gl'+i});f.appendChild(el('feGaussianBlur',{stdDeviation:'3.5',result:'b'}));var m=el('feMerge',{});m.appendChild(el('feMergeNode',{'in':'b'}));m.appendChild(el('feMergeNode',{'in':'SourceGraphic'}));f.appendChild(m);defs.appendChild(f)}
  var gr=el('linearGradient',{id:'sg',x1:'0',y1:'0',x2:'1',y2:'1'});gr.appendChild(el('stop',{offset:'0%','stop-color':'#1a2540'}));gr.appendChild(el('stop',{offset:'100%','stop-color':'#0e1425'}));defs.appendChild(gr);
  svg.appendChild(defs);
  drawSubnetBlocks(svg);
  drawTopology(svg,false);

  if(features.xtalk){findCrosstalk().forEach(function(r){var col=r.risk==='high'?'#f87171':'#fb923c',op=r.risk==='high'?.18:.1;
    var mx=(r.x1+r.x2)/2,my=(r.y1+r.y2)/2,h=Math.abs(r.y2-r.y1)+30,w=r.x2-r.x1+20;
    svg.appendChild(el('rect',{x:r.x1-10,y:my-h/2,width:w,height:h,rx:6,fill:col,opacity:op,stroke:col,'stroke-width':.6,'stroke-opacity':op*2,'stroke-dasharray':'4 3'}));
    svg.appendChild(el('text',{x:mx,y:my-h/2+10,'text-anchor':'middle',fill:col,'font-size':7,'font-family':'inherit','font-weight':700,opacity:.6,text:r.risk==='high'?'‚ö† XTALK':'~ xtalk'}))})}

  for(var idx=0;idx<N;idx++){var d=buildPathD(idx);if(!d)continue;
    var hit=el('path',{d:d,fill:'none',stroke:'transparent','stroke-width':40,opacity:0,style:'cursor:pointer'});
    (function(v){
      
      
      hit.addEventListener('click',function(){toggleHL(v);renderSVG()});
    })(idx);
    svg.appendChild(hit);
    var act=isHL(idx),col=COLORS[idx];
    var dash=locked[idx]&&act?'8 4':'none';
    var pathEl=el('path',{d:d,fill:'none',stroke:col,'stroke-width':act?3:.6,opacity:act?.95:.04,
      'stroke-dasharray':dash,'stroke-linecap':'round','stroke-linejoin':'round','pointer-events':'none'});
    if(animatePaths&&act){pathEl.setAttribute('stroke-dasharray','2000');pathEl.setAttribute('stroke-dashoffset','2000');pathEl.classList.add('path-anim');pathEl.style.animationDelay=(idx*0.08)+'s'}
    svg.appendChild(pathEl);
    if(act&&highlight.has(idx)){
      svg.appendChild(el('path',{d:d,fill:'none',stroke:col,'stroke-width':5,opacity:.35,
        filter:'url(#gl'+idx+')','stroke-linecap':'round','stroke-linejoin':'round','pointer-events':'none'}))}}

  if(features.loss){for(var idx=0;idx<N;idx++){var loss=calcLoss(idx);if(loss===null)continue;
    var act=isHL(idx),ls=pathData[idx].positions[5].sw;
    var lx=STAGE_X[5]+SW_W+22,ly=yTop(ls)-8,lc=loss<4.5?'#4ade80':loss<5.5?'#facc15':'#f87171';
    svg.appendChild(el('rect',{x:lx-2,y:ly-9,width:46,height:14,rx:4,fill:lc+'15',stroke:lc+'30','stroke-width':.5,opacity:act?1:.1}));
    svg.appendChild(el('text',{x:lx+21,y:ly,'text-anchor':'middle',fill:lc,'font-size':8,'font-family':'inherit','font-weight':700,opacity:act?.9:.08,text:'-'+loss.toFixed(1)+' dB'}))}}

  for(var idx=0;idx<N;idx++){if(pathData[idx])continue;var y=yTop(idx),act=isHL(idx);
    var g=el('g',{opacity:act?.9:.2});g.appendChild(el('line',{x1:110,y1:y,x2:STAGE_X[1],y2:y,stroke:'#f87171','stroke-width':1.8,'stroke-dasharray':'6 4'}));
    var bx=STAGE_X[0]+SW_W+20;g.appendChild(el('rect',{x:bx,y:y-10,width:68,height:18,rx:5,fill:'#f8717118',stroke:'#f87171','stroke-width':.8}));
    g.appendChild(el('text',{x:bx+34,y:y+2.5,'text-anchor':'middle',fill:'#f87171','font-size':9,'font-family':'inherit','font-weight':700,text:'NO ROUTE'}));svg.appendChild(g)}

  drawSwitches(svg,'gl','sg');

  var SQ=24;
  for(var i=0;i<N;i++){var y=SWY[i],act=isHL(i);
    var col=COLORS[i];
    var g=el('g',{style:'cursor:pointer',opacity:act?1:.18});
    g.appendChild(el('rect',{x:60,y:y-20,width:44,height:40,fill:'transparent',style:'cursor:pointer'}));
    g.appendChild(el('rect',{x:68,y:y-SQ/2,width:SQ+8,height:SQ,rx:3,fill:col+'15',stroke:col+'45','stroke-width':.8}));
    g.appendChild(el('text',{x:84,y:y+5,'text-anchor':'middle',fill:col,'font-size':13,'font-family':'inherit','font-weight':700,text:''+i}));
    (function(v){
      g.addEventListener('click',function(){toggleHL(v);renderSVG()});
    })(i);svg.appendChild(g)}

  var oX=STAGE_X[5]+SW_W+72,SQ=24;
  for(var j=0;j<N;j++){var sr=-1;for(var i=0;i<N;i++)if(pathData[i]&&pathData[i].output===j){sr=i;break}
    var has=sr!==-1,act=highlight.size===0||(has&&highlight.has(sr)),y=SWY[j];
    var g=el('g',{opacity:act?1:.15,style:'cursor:pointer'});var vc=has?COLORS[sr]:'#334155';
    g.appendChild(el('rect',{x:oX-5,y:y-SQ/2-4,width:SQ+60,height:SQ+8,fill:'transparent',style:'cursor:pointer'}));
    g.appendChild(el('rect',{x:oX,y:y-SQ/2,width:SQ+8,height:SQ,rx:3,fill:vc+'15',stroke:vc+'45','stroke-width':.8}));
    g.appendChild(el('text',{x:oX+16,y:y+5,'text-anchor':'middle',fill:vc,'font-size':13,'font-family':'inherit','font-weight':700,text:has?''+perm[sr]:'‚Äî'}));
    g.appendChild(el('text',{x:oX+50,y:y+5,'text-anchor':'middle',fill:'#64748b','font-size':11,'font-family':'inherit','font-weight':500,text:''+j}));
    if(has){(function(v){
      
      
      g.addEventListener('click',function(){toggleHL(v);renderSVG()});
    })(sr)}
    svg.appendChild(g)}

  for(var i=0;i<N;i++){if(!locked[i]||!pathData[i])continue;var mid=pathData[i].positions[3];
    svg.appendChild(el('text',{x:STAGE_X[3]+SW_W+10,y:SWY[mid.sw]-PG/2-10,'font-size':11,opacity:isHL(i)?.8:.08,text:'üîí'}))}
  var sn=['Stage 1','Stage 2','Stage 3','Stage 4','Stage 5','Stage 6'];
  for(var i=0;i<STAGES;i++){var cnt=0;for(var sw=0;sw<8;sw++)if(switchUsage[i+'-'+sw]!==undefined)cnt++;
    svg.appendChild(el('text',{x:STAGE_X[i]+SW_W/2,y:SVG_H-8,'text-anchor':'middle',fill:'#475569','font-size':10,'font-family':'inherit','font-weight':600,text:sn[i]}));
    svg.appendChild(el('text',{x:STAGE_X[i]+SW_W/2,y:SVG_H-22,'text-anchor':'middle',fill:'#334155','font-size':9,'font-family':'inherit',text:cnt+'/8'}))}
  var sl=['‚äï4','‚äï2','‚äï1','‚äï2','‚äï4'];
  for(var i=0;i<5;i++){var mx=(STAGE_X[i]+SW_W+STAGE_X[i+1])/2;
    svg.appendChild(el('text',{x:mx,y:SVG_H-10,'text-anchor':'middle',fill:'#64748b','font-size':8,'font-family':'inherit','font-weight':600,opacity:.5,text:sl[i]}))}

  if(features.photon)renderPhotons();
  buildCtrlPanel();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  HTML OVERLAY CONTROLS (positioned over SVG)
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

function buildCtrlPanel(){
  var panel=document.getElementById('ctrlPanel');if(!panel)return;
  panel.innerHTML='';
  // Row 1: Channel highlight toggles
  var row1=document.createElement('div');row1.className='ctrl-row';
  // Row 2: Output dropdowns
  var row2=document.createElement('div');row2.className='ctrl-row';
  // Row 3: Lock buttons
  var row3=document.createElement('div');row3.className='ctrl-row';

  for(var i=0;i<N;i++){
    var col=COLORS[i];
    var isOn=highlight.has(i);
    var isOff=highlight.size>0&&!isOn;

    // Channel highlight button
    var ch=document.createElement('button');
    ch.className='ctrl-ch'+(isOn?' on':'')+(isOff?' off':'');
    ch.textContent=i;
    ch.style.color=col;ch.style.borderColor=isOn?col:col+'50';
    ch.style.background=isOn?col+'30':col+'10';
    ch.dataset.i=i;
    ch.addEventListener('click',function(e){
      e.stopPropagation();
      var v=+this.dataset.i;
      toggleHL(v);renderSVG();
    });
    row1.appendChild(ch);

    // Output dropdown
    var wrap=document.createElement('div');
    wrap.className='ctrl-dd-wrap';
    var sel=document.createElement('select');
    sel.className='ctrl-dd';
    sel.style.color=col;sel.style.borderColor=col+'80';
    sel.style.background=col+'10';
    sel.disabled=locked[i];
    for(var j=0;j<N;j++){
      var opt=document.createElement('option');opt.value=j;
      opt.textContent='‚Üí'+j;
      if(perm[i]===j)opt.selected=true;
      sel.appendChild(opt);
    }
    sel.dataset.i=i;
    sel.addEventListener('change',function(e){
      e.stopPropagation();
      handlePermChange(+this.dataset.i,+e.target.value);render();
    });
    var arrow=document.createElement('span');
    arrow.className='ctrl-dd-arrow';arrow.textContent='‚ñæ';arrow.style.color=col;
    wrap.appendChild(sel);wrap.appendChild(arrow);
    row2.appendChild(wrap);

    // Lock button
    var lk=document.createElement('button');
    lk.className='ctrl-lk'+(locked[i]?' on':'');
    lk.textContent=locked[i]?'üîí':'üîì';
    lk.style.color=locked[i]?col:'#475569';
    lk.style.borderColor=locked[i]?col:'#475569';
    lk.dataset.i=i;
    lk.addEventListener('click',function(e){
      e.stopPropagation();toggleLock(+this.dataset.i);render();
    });
    row3.appendChild(lk);
  }
  panel.appendChild(row1);
  panel.appendChild(row2);
  panel.appendChild(row3);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  PHOTON ANIMATION
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function renderPhotons(){var svg=document.getElementById('mainSvg');
  svg.querySelectorAll('.photon-g').forEach(function(e){e.remove()});
  if(!features.photon)return;
  for(var idx=0;idx<N;idx++){var d=buildPathD(idx);if(!d)continue;
    var act=isHL(idx);if(!act)continue;var col=COLORS[idx];
    for(var p=0;p<3;p++){var g=el('g',{'class':'photon-g'});
      g.appendChild(el('circle',{r:5,fill:col,opacity:.15,filter:'url(#gl'+idx+')'}));
      g.appendChild(el('circle',{r:2.5,fill:col,opacity:.9}));g.appendChild(el('circle',{r:1,fill:'#fff',opacity:.7}));
      var am=el('animateMotion',{dur:(2.2+p*.15)+'s',repeatCount:'indefinite',begin:(p*.7)+'s'});am.setAttribute('path',d);
      g.appendChild(am);svg.appendChild(g)}}}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  NETWORK VIEW
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function openFocus(){
  document.getElementById('focusOverlay').classList.add('show');
  // Auto-fit in landscape
  var wrap=document.getElementById('focusWrap');
  if(window.innerWidth>window.innerHeight&&!wrap.classList.contains('compact')){
    wrap.classList.add('compact');
    focusCompact=true;
    var fb=document.getElementById('foCompactBtn');if(fb)fb.classList.add('on');
  }
  var leg=document.getElementById('focusLegend');
  leg.innerHTML=
    '<div class="fo-leg-item"><div class="fo-leg-dot" style="background:#818cf8"></div>8√ó8 Full Network</div>'+
    '<div class="fo-leg-item"><div class="fo-leg-dot" style="background:#38bdf8"></div>4√ó4 Upper Sub-net</div>'+
    '<div class="fo-leg-item"><div class="fo-leg-dot" style="background:#fb923c"></div>4√ó4 Lower Sub-net</div>'+
    '<div class="fo-leg-item"><div class="fo-leg-dot" style="background:#4ade80"></div>2√ó2 Core Blocks</div>'+
    '<div class="fo-leg-item" style="color:#64748b">‚îÄ‚îÄ bar (straight) ¬∑ ‚ï≤ cross (XOR stride)</div>';
  renderFocusSVG();
}
function closeFocus(){document.getElementById('focusOverlay').classList.remove('show')}

function renderFocusSVG(){
  var svg=document.getElementById('focusSvg');svg.innerHTML='';
  var defs=el('defs',{});
  var cols=['#818cf8','#38bdf8','#fb923c','#4ade80','#facc15'];
  cols.forEach(function(c,ci){var f=el('filter',{id:'fg'+ci,x:'-20%',y:'-20%',width:'140%',height:'140%'});
    f.appendChild(el('feGaussianBlur',{stdDeviation:'6',result:'b','in':'SourceGraphic'}));
    var m=el('feMerge',{});m.appendChild(el('feMergeNode',{'in':'b'}));m.appendChild(el('feMergeNode',{'in':'SourceGraphic'}));f.appendChild(m);defs.appendChild(f)});
  var gr=el('linearGradient',{id:'fsg',x1:'0',y1:'0',x2:'1',y2:'1'});
  gr.appendChild(el('stop',{offset:'0%','stop-color':'#1a2540'}));gr.appendChild(el('stop',{offset:'100%','stop-color':'#0e1425'}));defs.appendChild(gr);
  var ogr=el('linearGradient',{id:'ofg',x1:'0',y1:'0',x2:'1',y2:'1'});
  ogr.appendChild(el('stop',{offset:'0%','stop-color':'#818cf8','stop-opacity':'.12'}));ogr.appendChild(el('stop',{offset:'100%','stop-color':'#c084fc','stop-opacity':'.06'}));defs.appendChild(ogr);
  svg.appendChild(defs);

  var oP=26,iP=16,coreP=10;

  var fy1=SWY[0]-SW_H/2-oP-12, fy2=SWY[7]+SW_H/2+oP+12;
  var fx1=STAGE_X[0]-oP-10, fx2=STAGE_X[5]+SW_W+oP+10;
  svg.appendChild(el('rect',{x:fx1,y:fy1,width:fx2-fx1,height:fy2-fy1,rx:16,
    fill:'url(#ofg)',stroke:'#818cf8','stroke-width':1.5,'stroke-opacity':.25}));
  svg.appendChild(el('text',{x:fx1+10,y:fy1+14,fill:'#818cf8','font-size':10,'font-family':'Outfit,sans-serif','font-weight':700,'letter-spacing':'.1em',opacity:.6,text:'8√ó8 DILATED BENE≈†'}));

  function midBlock(r1,r2,color,label){
    var y1=SWY[r1]-SW_H/2-oP, y2=SWY[r2]+SW_H/2+oP;
    var x1=STAGE_X[1]-oP, x2=STAGE_X[4]+SW_W+oP;
    svg.appendChild(el('rect',{x:x1,y:y1,width:x2-x1,height:y2-y1,rx:14,
      fill:color+'0a',stroke:color,'stroke-width':1.4,'stroke-opacity':.3}));
    svg.appendChild(el('text',{x:x1+8,y:y1+13,fill:color,'font-size':9,'font-family':'Outfit,sans-serif','font-weight':700,'letter-spacing':'.08em',opacity:.65,text:label}));
  }
  midBlock(0,3,'#38bdf8','4√ó4 UPPER SUB-NETWORK');
  midBlock(4,7,'#fb923c','4√ó4 LOWER SUB-NETWORK');

  var coreColors=['#4ade80','#facc15','#facc15','#4ade80'];
  var corePairs=[[0,1],[2,3],[4,5],[6,7]];
  var coreNames=['2√ó2 BLOCK A','2√ó2 BLOCK B','2√ó2 BLOCK C','2√ó2 BLOCK D'];
  corePairs.forEach(function(pair,ci){
    var y1=SWY[pair[0]]-SW_H/2-coreP, y2=SWY[pair[1]]+SW_H/2+coreP;
    var x1=STAGE_X[2]-coreP, x2=STAGE_X[3]+SW_W+coreP;
    var cc=coreColors[ci];
    svg.appendChild(el('rect',{x:x1,y:y1,width:x2-x1,height:y2-y1,rx:8,
      fill:cc+'0c',stroke:cc,'stroke-width':1.2,'stroke-opacity':.35}));
    svg.appendChild(el('text',{x:x1+6,y:y1+10,fill:cc,'font-size':7,'font-family':'Outfit,sans-serif','font-weight':700,'letter-spacing':'.06em',opacity:.6,text:coreNames[ci]}));
  });

  var strideCols=['#818cf8','#38bdf8','#4ade80','#38bdf8','#818cf8'];
  for(var s=0;s<5;s++){
    var d=STRIDES[s], sc=strideCols[s];
    for(var r=0;r<8;r++){
      var sD=r, cD=r^d;
      var x1=STAGE_X[s]+SW_W, x2=STAGE_X[s+1];
      var sP,cP;
      if(SWY[sD]<=SWY[cD]){sP='top';cP='bot'}else{sP='bot';cP='top'}
      var barConn=connLookup[s+'-'+r+'-bar'];
      var crossConn=connLookup[s+'-'+r+'-cross'];
      if(barConn){
        var by1=yPort(r,barConn.srcPort), by2=yPort(barConn.destSw,barConn.destPort);
        svg.appendChild(el('path',{d:bezD(x1,by1,x2,by2),fill:'none',stroke:sc,'stroke-width':1.2,opacity:.35}));
      }
      if(crossConn){
        var cy1=yPort(r,crossConn.srcPort), cy2=yPort(crossConn.destSw,crossConn.destPort);
        svg.appendChild(el('path',{d:bezD(x1,cy1,x2,cy2),fill:'none',stroke:sc,'stroke-width':1.6,opacity:.5,'stroke-dasharray':'6 3'}));
      }
    }
  }

  for(var i=0;i<8;i++){
    svg.appendChild(el('line',{x1:50,y1:yTop(i),x2:STAGE_X[0],y2:yTop(i),stroke:'#5a6580','stroke-width':1.2,opacity:.5}));
    svg.appendChild(el('line',{x1:STAGE_X[5]+SW_W,y1:yTop(i),x2:SVG_W-50,y2:yTop(i),stroke:'#5a6580','stroke-width':1.2,opacity:.5}));
  }

  for(var si=0;si<STAGES;si++){
    var stageCol='#5a6580';
    if(si===0||si===5) stageCol='#818cf8';
    else if(si===1||si===4) stageCol='#38bdf8';
    else stageCol='#4ade80';

    for(var sw=0;sw<8;sw++){
      var cx=STAGE_X[si],cy=SWY[sw];
      var swCol=stageCol;
      if(si>=2&&si<=3){
        if(sw<=1||sw>=6) swCol='#4ade80';
        else swCol='#facc15';
      }
      var g=el('g',{opacity:.75});
      g.appendChild(el('rect',{x:cx,y:cy-SW_H/2,width:SW_W,height:SW_H,rx:7,fill:'url(#fsg)',stroke:swCol,'stroke-width':1}));
      [[cx,yTop(sw)],[cx,yBot(sw)],[cx+SW_W,yTop(sw)],[cx+SW_W,yBot(sw)]].forEach(function(pp){
        g.appendChild(el('circle',{cx:pp[0],cy:pp[1],r:3.5,fill:swCol+'30',stroke:swCol,'stroke-width':.8,opacity:.9}))});
      g.appendChild(el('line',{x1:cx+12,y1:yTop(sw),x2:cx+SW_W-12,y2:yTop(sw),stroke:swCol,'stroke-width':.6,opacity:.3}));
      g.appendChild(el('line',{x1:cx+12,y1:yBot(sw),x2:cx+SW_W-12,y2:yBot(sw),stroke:swCol,'stroke-width':.6,opacity:.3}));
      g.appendChild(el('line',{x1:cx+12,y1:yTop(sw),x2:cx+SW_W-12,y2:yBot(sw),stroke:swCol,'stroke-width':.4,opacity:.2,'stroke-dasharray':'2 3'}));
      g.appendChild(el('line',{x1:cx+12,y1:yBot(sw),x2:cx+SW_W-12,y2:yTop(sw),stroke:swCol,'stroke-width':.4,opacity:.2,'stroke-dasharray':'2 3'}));
      g.appendChild(el('text',{x:cx+SW_W/2,y:cy+4,'text-anchor':'middle',fill:swCol,'font-size':10,'font-family':'Outfit,sans-serif','font-weight':700,opacity:.7,text:''+sw}));
      svg.appendChild(g);
    }
  }

  for(var i=0;i<N;i++){var y=SWY[i];
    svg.appendChild(el('text',{x:38,y:y+5,'text-anchor':'end',fill:'#94a3b8','font-size':14,'font-family':'Outfit,sans-serif','font-weight':700,text:'In '+i}));
    svg.appendChild(el('text',{x:38,y:y+17,'text-anchor':'end',fill:'#475569','font-size':9,'font-family':'inherit','font-weight':600,text:((i>>2)&1)+''+((i>>1)&1)+''+(i&1)}));
    svg.appendChild(el('text',{x:SVG_W-38,y:y+5,'text-anchor':'start',fill:'#94a3b8','font-size':14,'font-family':'Outfit,sans-serif','font-weight':700,text:'Out '+i}));
    svg.appendChild(el('text',{x:SVG_W-38,y:y+17,'text-anchor':'start',fill:'#475569','font-size':9,'font-family':'inherit','font-weight':600,text:((i>>2)&1)+''+((i>>1)&1)+''+(i&1)}));
  }

  var sn=['STAGE 0','STAGE 1','STAGE 2','STAGE 3','STAGE 4','STAGE 5'];
  var stColArr=['#818cf8','#38bdf8','#4ade80','#4ade80','#38bdf8','#818cf8'];
  for(var i=0;i<STAGES;i++){
    svg.appendChild(el('text',{x:STAGE_X[i]+SW_W/2,y:625,'text-anchor':'middle',fill:stColArr[i],'font-size':11,'font-family':'Outfit,sans-serif','font-weight':700,'letter-spacing':'.06em',opacity:.7,text:sn[i]}));
    var role=i===0?'DEMUX':i===5?'MUX':i===1||i===4?'SPREAD/GATHER':'CORE';
    svg.appendChild(el('text',{x:STAGE_X[i]+SW_W/2,y:639,'text-anchor':'middle',fill:stColArr[i],'font-size':7,'font-family':'inherit','font-weight':600,'letter-spacing':'.06em',opacity:.4,text:role}));
  }

  var slTxt=['‚äï4','‚äï2','‚äï1','‚äï2','‚äï4'];
  var slDesc=['flip bit‚ÇÇ','flip bit‚ÇÅ','flip bit‚ÇÄ','flip bit‚ÇÅ','flip bit‚ÇÇ'];
  for(var i=0;i<5;i++){
    var mx=(STAGE_X[i]+SW_W+STAGE_X[i+1])/2;
    svg.appendChild(el('text',{x:mx,y:655,'text-anchor':'middle',fill:strideCols[i],'font-size':12,'font-family':'Outfit,sans-serif','font-weight':800,opacity:.65,text:slTxt[i]}));
    svg.appendChild(el('text',{x:mx,y:667,'text-anchor':'middle',fill:strideCols[i],'font-size':7,'font-family':'inherit','font-weight':600,opacity:.35,text:slDesc[i]}));
  }

  svg.appendChild(el('line',{x1:SVG_W-200,y1:18,x2:SVG_W-160,y2:18,stroke:'#5a6580','stroke-width':1.3,opacity:.5}));
  svg.appendChild(el('text',{x:SVG_W-155,y:21,fill:'#5a6580','font-size':9,'font-family':'inherit','font-weight':600,text:'bar (straight)'}));
  svg.appendChild(el('line',{x1:SVG_W-200,y1:32,x2:SVG_W-160,y2:32,stroke:'#5a6580','stroke-width':1.6,opacity:.6,'stroke-dasharray':'6 3'}));
  svg.appendChild(el('text',{x:SVG_W-155,y:35,fill:'#5a6580','font-size':9,'font-family':'inherit','font-weight':600,text:'cross (XOR stride)'}));

  svg.appendChild(el('text',{x:SVG_W/2,y:18,'text-anchor':'middle',fill:'#818cf8','font-size':11,'font-family':'Outfit,sans-serif','font-weight':700,'letter-spacing':'.12em',opacity:.6,text:'NETWORK ARCHITECTURE'}));
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  MONITORING
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
var monitorData=Array(N).fill(null).map(function(){return{power:-3,ber:1e-12,osnr:35}});
function simMonitor(){for(var i=0;i<N;i++){var has=routes[i]!==null,loss=has?calcLoss(i):0,dr=(Math.random()-.5)*.3;
  monitorData[i].power=has?(-2-loss+dr):(-40+Math.random()*2);monitorData[i].osnr=has?(38-loss*1.5+dr*2):(5+Math.random()*3);
  monitorData[i].ber=Math.pow(10,has?(-12+loss*.4+Math.random()*.5):(-3+Math.random()))}
  if(features.monitor)renderMonitor()}
function renderMonitor(){var grid=document.getElementById('monGrid');grid.innerHTML='';
  for(var i=0;i<N;i++){var d=monitorData[i],has=routes[i]!==null,col=has?COLORS[i]:'#334155';
    var pn=has?Math.max(0,Math.min(1,(d.power+10)/10)):0,pc=d.power>-5?'#4ade80':d.power>-8?'#facc15':'#f87171';
    var bs=d.ber.toExponential(1),bc=d.ber<1e-9?'#4ade80':d.ber<1e-6?'#facc15':'#f87171',oc=d.osnr>30?'#4ade80':d.osnr>20?'#facc15':'#f87171';
    var c=document.createElement('div');c.className='mcell';c.style.borderColor=has?col+'30':'var(--border)';
    if(has)c.style.boxShadow='0 0 12px '+col+'08';
    c.innerHTML='<div class="mch" style="color:'+col+'">CH '+(i+1)+'</div><div style="font-size:10px;font-weight:700;color:'+pc+'">'+d.power.toFixed(1)+' <span style="font-size:8px;color:var(--dim)">dBm</span></div><div class="mbar"><div class="mbar-fill" style="width:'+(pn*100)+'%;background:'+pc+'"></div></div><div style="font-size:9px;color:'+bc+'">BER '+bs+'</div><div style="font-size:9px;color:'+oc+'">OSNR '+d.osnr.toFixed(1)+'</div>';
    grid.appendChild(c)}}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  UI
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function renderStatus(){var rc=0,ac=0,lc=0;for(var i=0;i<N;i++){if(routes[i])rc++;if(locked[i])lc++}for(var k in switchUsage)ac++;var ok=rc===N;
  document.getElementById('statusBar').innerHTML='<div class="pill" style="border-color:'+(ok?'var(--green)':'var(--red)')+';color:'+(ok?'var(--green)':'var(--red)')+'"><span class="dot" style="background:'+(ok?'var(--green)':'var(--red)')+'"></span>'+rc+'/'+N+' ROUTED '+(ok?'‚úì':'‚ö†')+'</div><div class="pill" style="border-color:var(--border);color:var(--muted)">Active: '+ac+'/48</div><div class="pill" style="border-color:rgba(250,204,21,.25);color:var(--yellow)">üîí '+lc+'</div>'}
function updateRerouteBtn(){var hl=false;for(var i=0;i<N;i++)if(locked[i])hl=true;
  var btn=document.getElementById('rerouteBtn');btn.className='rbtn '+(hl?'on':'off');btn.textContent=hl?'‚ö° REROUTE':'LOCK PATHS FIRST'}
function renderPresets(){var bar=document.getElementById('presetsBar');
  [{name:'Identity',p:[0,1,2,3,4,5,6,7]},{name:'Reverse',p:[7,6,5,4,3,2,1,0]},{name:'Shift+1',p:[1,2,3,4,5,6,7,0]},{name:'Swap',p:[1,0,3,2,5,4,7,6]},{name:'Interleave',p:[0,4,1,5,2,6,3,7]},{name:'Random',p:null}].forEach(function(pr){
    var b=document.createElement('button');b.className='pbtn';b.textContent=pr.name;
    b.addEventListener('click',function(){var p=pr.p;if(!p){p=[0,1,2,3,4,5,6,7];for(var i=7;i>0;i--){var j=Math.floor(Math.random()*(i+1));var t=p[i];p[i]=p[j];p[j]=t}}
      var svg=document.getElementById('mainSvg');
      svg.classList.add('transitioning');
      setTimeout(function(){
        perm=p.slice();locked=Array(N).fill(false);frozenRoutes=Array(N).fill(null);highlight=new Set();
        animatePaths=true;render();
        svg.classList.remove('transitioning');
        setTimeout(function(){animatePaths=false},1000);
      },150)});bar.appendChild(b)})}
function showMsg(t,txt){var e=document.getElementById('rerouteMsg');
  if(t==='success')e.innerHTML='<span class="rmsg" style="color:var(--green);background:rgba(74,222,128,.06);border-color:rgba(74,222,128,.2)">'+txt+'</span>';
  else if(t==='warn')e.innerHTML='<span class="rmsg" style="color:var(--red);background:rgba(248,113,113,.06);border-color:rgba(248,113,113,.2)">'+txt+'</span>';else e.innerHTML=''}
function handlePermChange(i,o){if(locked[i])return;var ex=perm.indexOf(o);if(ex!==-1&&ex!==i){if(locked[ex])return;perm[ex]=perm[i]}perm[i]=o}
function toggleLock(i){locked[i]=!locked[i];if(locked[i])frozenRoutes[i]=routes[i];else frozenRoutes[i]=null}
function handleReroute(){var hl=false;for(var i=0;i<N;i++)if(locked[i])hl=true;if(!hl)return;
  var pre=Array(N).fill(null);for(var i=0;i<N;i++)if(locked[i]&&frozenRoutes[i])pre[i]=frozenRoutes[i];var nr=routeAll(perm,pre);
  if(nr.every(function(r){return r!==null})){routes=nr;pathData=routes.map(function(r,i){return r?trace(i,r):null});
    switchUsage={};pathData.forEach(function(pd,i){if(pd)pd.positions.forEach(function(p){switchUsage[p.stage+'-'+p.sw]=i})});
    showMsg('success','‚úì Rerouted!');renderSVG();renderStatus()}
  else{var fail=[],lks=[];for(var i=0;i<N;i++){if(!nr[i])fail.push(i);if(locked[i])lks.push(i)}
    document.getElementById('failedChips').innerHTML=fail.map(function(s){return'<span class="mchip" style="background:'+COLORS[s]+'25;color:'+COLORS[s]+';border-color:'+COLORS[s]+'50">In'+s+'‚Üí'+perm[s]+'</span>'}).join('');
    document.getElementById('lockedChips').innerHTML=lks.map(function(s){return'<span class="mchip" style="background:'+COLORS[s]+'15;color:'+COLORS[s]+';border-color:'+COLORS[s]+'30">üîí'+s+'‚Üí'+perm[s]+'</span>'}).join('');
    document.getElementById('modal').classList.add('show')}}
function handleForceReroute(){locked=Array(N).fill(false);frozenRoutes=Array(N).fill(null);closeModal();render()}
function closeModal(){document.getElementById('modal').classList.remove('show')}
function render(){compute();renderStatus();updateRerouteBtn();renderSVG();simMonitor();document.getElementById('rerouteMsg').innerHTML=''}
renderPresets();animatePaths=true;render();setTimeout(function(){animatePaths=false},1000);
// Tap on empty SVG background to deselect
document.getElementById('mainSvg').addEventListener('click',function(e){
  if(e.target===document.getElementById('mainSvg')&&highlight.size>0){highlight=new Set();renderSVG()}
});
window.addEventListener('resize',function(){buildCtrlPanel()});
setInterval(function(){if(features.monitor)simMonitor()},1500);

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  TOAST
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function showToast(msg){
  var t=document.getElementById('toast');t.textContent=msg;t.classList.add('show');
  setTimeout(function(){t.classList.remove('show')},2200);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  FULLSCREEN
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function goFullscreen(){
  var el=document.getElementById('svgWrap');
  if(el.requestFullscreen)el.requestFullscreen();
  else if(el.webkitRequestFullscreen)el.webkitRequestFullscreen();
  else if(el.msRequestFullscreen)el.msRequestFullscreen();
}
function exitFullscreen(){
  if(document.exitFullscreen)document.exitFullscreen();
  else if(document.webkitExitFullscreen)document.webkitExitFullscreen();
  else if(document.msExitFullscreen)document.msExitFullscreen();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  KEYBOARD SHORTCUTS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
var presetKeys=[
  {p:[0,1,2,3,4,5,6,7],n:'Identity'},
  {p:[7,6,5,4,3,2,1,0],n:'Reverse'},
  {p:[1,2,3,4,5,6,7,0],n:'Shift+1'},
  {p:[1,0,3,2,5,4,7,6],n:'Swap'},
  {p:[0,4,1,5,2,6,3,7],n:'Interleave'},
  {p:null,n:'Random'}
];
document.addEventListener('keydown',function(e){
  if(e.target.tagName==='INPUT'||e.target.tagName==='SELECT'||e.target.tagName==='TEXTAREA')return;
  var k=e.key.toLowerCase();
  if(k>='1'&&k<='6'){e.preventDefault();var pi=parseInt(k)-1,pr=presetKeys[pi];
    var p=pr.p;if(!p){p=[0,1,2,3,4,5,6,7];for(var i=7;i>0;i--){var j=Math.floor(Math.random()*(i+1));var t=p[i];p[i]=p[j];p[j]=t}}
    var svg=document.getElementById('mainSvg');svg.classList.add('transitioning');
    setTimeout(function(){
      perm=p.slice();locked=Array(N).fill(false);frozenRoutes=Array(N).fill(null);highlight=new Set();
      animatePaths=true;render();svg.classList.remove('transitioning');
      setTimeout(function(){animatePaths=false},1000);showToast('‚å® '+pr.n);
    },150);return}
  if(k==='l'){e.preventDefault();for(var i=0;i<N;i++){if(routes[i]&&!locked[i]){locked[i]=true;frozenRoutes[i]=routes[i]}}render();showToast('üîí All locked');return}
  if(k==='u'){e.preventDefault();locked=Array(N).fill(false);frozenRoutes=Array(N).fill(null);render();showToast('üîì All unlocked');return}
  if(k==='r'){e.preventDefault();handleReroute();return}
  if(k==='f'){e.preventDefault();toggleCompact();showToast(compactMode?'‚õ∂ Fit on':'‚õ∂ Fit off');return}
  if(k==='escape'){exitFullscreen();closeFocus();closeModal();return}
});

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  AUTO FIT SCREEN
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// Always start with fit on
if(!compactMode) toggleCompact();

// Force fit in landscape at any width
function checkAutoFit(){
  var isLandscape=window.innerWidth>window.innerHeight;
  if(isLandscape&&!compactMode){
    toggleCompact();
  }
  // Auto-hide address bar: scroll trick + fullscreen request
  if(isLandscape){
    // Scroll trick pushes address bar up on most mobile browsers
    setTimeout(function(){window.scrollTo(0,1)},100);
  }
}
window.addEventListener('orientationchange',function(){setTimeout(checkAutoFit,300)});
window.addEventListener('resize',function(){
  clearTimeout(window._fitTimer);
  window._fitTimer=setTimeout(checkAutoFit,300);
});

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  SPLASH SCREEN
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
(function(){
  var splash=document.getElementById('splash');
  var dash=document.getElementById('mainDash');
  setTimeout(function(){
    splash.classList.add('hide');
    dash.style.transition='opacity .5s ease-out';
    dash.style.opacity='1';
    setTimeout(function(){
      splash.style.display='none';
    },600);
  },2200);
})();
</script>
</body>
</html>
